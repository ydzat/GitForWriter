name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.email "ci@github.com"
        git config --global user.name "GitHub CI"

    - name: Install vsce
      run: npm install -g @vscode/vsce

    - name: Build extension
      run: npm run compile

    - name: Run tests
      run: npm run test:unit:compiled
    
    - name: Package extension
      run: vsce package
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Create Release Notes
      id: release_notes
      run: |
        # Extract release notes from CHANGELOG.md
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        # Create release notes file
        cat > release_notes.md << 'EOF'
        ## GitForWriter v${{ steps.get_version.outputs.VERSION }}
        
        See [CHANGELOG.md](https://github.com/ydzat/GitForWriter/blob/main/CHANGELOG.md) for detailed changes.
        
        ### Installation
        
        **From VSCode Marketplace:**
        1. Open VSCode
        2. Go to Extensions (Ctrl+Shift+X / Cmd+Shift+X)
        3. Search for "GitForWriter"
        4. Click Install
        
        **From VSIX file:**
        ```bash
        code --install-extension gitforwriter-${{ steps.get_version.outputs.VERSION }}.vsix
        ```
        
        ### Quick Start
        
        1. Open Command Palette (Ctrl+Shift+P / Cmd+Shift+P)
        2. Run `GitForWriter: Configure AI Provider`
        3. Select your AI provider and configure API Key
        4. Run `GitForWriter: Start Writing Project` to initialize
        5. Start writing and use `GitForWriter: AI Review` for feedback
        
        ### Documentation
        
        - [中文文档](https://github.com/ydzat/GitForWriter/blob/main/README.md)
        - [English Documentation](https://github.com/ydzat/GitForWriter/blob/main/README_EN.md)
        - [Installation Guide](https://github.com/ydzat/GitForWriter/blob/main/INSTALL.md)
        - [Usage Examples](https://github.com/ydzat/GitForWriter/blob/main/EXAMPLE.md)
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        files: |
          *.vsix
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Publish to VSCode Marketplace
      if: success()
      run: vsce publish -p ${{ secrets.VSCE_PAT }}
      continue-on-error: true
    
    - name: Publish to Open VSX Registry
      if: success()
      run: |
        npm install -g ovsx
        ovsx publish *.vsix -p ${{ secrets.OVSX_PAT }}
      continue-on-error: true

